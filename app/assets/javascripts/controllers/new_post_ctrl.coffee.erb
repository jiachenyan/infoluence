
angular.module('Infoluence').controller 'NewPostController', [

 'CookieService'
 'UUID'
 'PostService'
 'FeedFactory'

 '$scope'
 '$stateParams'


 (CookieService,UUID,PostService,FeedFactory,$scope,$stateParams) ->

  $scope.me = null

  #post content is an array of object with different types
  $scope.content = []
  $scope.links = []

  $scope.linkUrl = ""
  $scope.previousLinkUrl = ""

  $scope.linkFetchStatus = null

  $scope.initNewPost = =>

   pg = 
    type:"pg"
    body:""

   $scope.content.push pg

  $scope.initializeLinkLoading = =>
   $scope.linkFetchStatus = "fetching"


   PostService.parseLink($scope.linkUrl).then (res) =>
    console.log res.data
    $scope.linkFetchStatus = "fetched"
    $scope.links.push res.data






  $scope.submitPost = =>

   console.log "submitting"

   $scope.links.forEach (link) =>
    $scope.content.push link
   params =
    content:        
     title: $scope.title
     data:  $scope.content

   console.log params

   PostService.submitPost(params).then (res) =>
    console.log res.data
    FeedFactory.feed.unshift res.data

  $scope.$watch "linkUrl", =>
   if ($scope.linkUrl.length - $scope.previousLinkUrl.length) > 5
    $scope.initializeLinkLoading()



]
